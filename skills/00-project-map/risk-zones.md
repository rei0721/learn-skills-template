# 高风险区域标注

## 高风险区域定义

| 区域                    | 风险类型     | 风险等级 | 说明                                   |
| ----------------------- | ------------ | -------- | -------------------------------------- |
| internal/app/           | 改动成本高   | 🔴 极高  | 依赖注入容器，影响所有组件             |
| internal/config/        | 连锁反应     | 🔴 极高  | 配置变更影响所有依赖配置的组件         |
| pkg/database/           | 数据安全     | 🔴 极高  | 数据库操作，错误可能导致数据丢失       |
| pkg/dbtx/               | 事务一致性   | 🔴 极高  | 事务管理，错误可能导致数据不一致       |
| internal/models/        | 数据结构变更 | 🟠 高    | 模型变更需要数据库迁移                 |
| internal/middleware/    | 安全风险     | 🟠 高    | 认证授权中间件，错误可能导致安全漏洞   |
| pkg/jwt/                | 安全风险     | 🟠 高    | JWT 生成验证，错误可能导致认证绕过     |
| pkg/rbac/               | 权限风险     | 🟠 高    | 权限控制，错误可能导致越权访问         |
| pkg/crypto/             | 安全风险     | 🟠 高    | 密码加密，错误可能导致密码泄露         |
| internal/repository/    | 数据访问     | 🟡 中    | 数据访问层，错误可能导致数据查询异常   |
| internal/service/       | 业务逻辑     | 🟡 中    | 业务逻辑层，错误可能导致业务流程异常   |
| pkg/logger/             | 可观测性     | 🟡 中    | 日志系统，错误可能导致无法排查问题     |
| pkg/cache/              | 性能影响     | 🟢 低    | 缓存系统，错误影响性能但不影响功能     |
| pkg/executor/           | 性能影响     | 🟢 低    | 协程池，错误影响性能但不影响功能       |

## 详细风险说明

### 🔴 极高风险区域

#### 1. internal/app/ - 依赖注入容器

**风险描述**:
- App 结构体是整个应用的核心，管理所有组件的生命周期
- 初始化顺序错误可能导致应用无法启动
- 关闭顺序错误可能导致资源泄露或数据丢失

**操作约束**:
- ✅ 允许: 添加新组件（按照依赖顺序）
- ✅ 允许: 修改组件配置（不改变依赖关系）
- ❌ 禁止: 改变组件初始化顺序（除非明确理解依赖关系）
- ❌ 禁止: 删除现有组件（除非确认无依赖）
- ❌ 禁止: 在初始化过程中添加异步操作

**强制先读文档**:
- 修改前必须阅读 `docs/overview/architecture.md`
- 修改前必须阅读 `internal/app/app.go` 的注释
- 修改前必须确认依赖关系图

**测试要求**:
- 必须测试应用启动流程
- 必须测试应用关闭流程
- 必须测试组件初始化失败的情况

#### 2. internal/config/ - 配置管理

**风险描述**:
- 配置是所有组件的基础，配置错误可能导致应用无法启动
- 配置热重载可能导致运行时状态不一致
- 环境变量覆盖可能导致配置混乱

**操作约束**:
- ✅ 允许: 添加新配置项（提供默认值）
- ✅ 允许: 修改配置验证逻辑
- ❌ 禁止: 删除现有配置项（除非确认无使用）
- ❌ 禁止: 改变配置结构（会破坏向后兼容性）
- ❌ 禁止: 在配置加载过程中访问其他组件

**强制先读文档**:
- 修改前必须阅读 `docs/development/configuration.md`
- 修改前必须阅读 `internal/config/config.go` 的注释
- 修改前必须确认配置依赖关系

**测试要求**:
- 必须测试配置加载
- 必须测试配置验证
- 必须测试环境变量覆盖
- 必须测试配置热重载

#### 3. pkg/database/ - 数据库操作

**风险描述**:
- 数据库操作错误可能导致数据丢失或损坏
- 连接池配置不当可能导致连接耗尽
- SQL 注入风险

**操作约束**:
- ✅ 允许: 使用 GORM 的安全 API
- ✅ 允许: 添加数据库健康检查
- ❌ 禁止: 直接执行原始 SQL（除非必要且经过审查）
- ❌ 禁止: 在事务外执行写操作（除非明确不需要事务）
- ❌ 禁止: 修改连接池配置（除非经过性能测试）

**强制先读文档**:
- 修改前必须阅读 `pkg/database/README.md`
- 修改前必须阅读 GORM 文档
- 修改前必须确认数据库操作的事务边界

**测试要求**:
- 必须测试数据库连接
- 必须测试数据库操作（CRUD）
- 必须测试连接池行为
- 必须测试错误处理

#### 4. pkg/dbtx/ - 事务管理

**风险描述**:
- 事务管理错误可能导致数据不一致
- 事务嵌套可能导致死锁
- 事务超时可能导致资源泄露

**操作约束**:
- ✅ 允许: 使用 WithTransaction 包装事务操作
- ✅ 允许: 设置合理的事务超时
- ❌ 禁止: 手动管理事务（使用 WithTransaction）
- ❌ 禁止: 在事务中执行长时间操作
- ❌ 禁止: 嵌套事务（除非明确支持）

**强制先读文档**:
- 修改前必须阅读 `pkg/dbtx/README.md`
- 修改前必须阅读 `pkg/dbtx/examples/basic/main.go`
- 修改前必须确认事务边界

**测试要求**:
- 必须测试事务提交
- 必须测试事务回滚
- 必须测试事务超时
- 必须测试并发事务

### 🟠 高风险区域

#### 5. internal/models/ - 数据模型

**风险描述**:
- 模型变更需要数据库迁移
- 字段类型变更可能导致数据丢失
- 关联关系变更可能导致数据不一致

**操作约束**:
- ✅ 允许: 添加新字段（提供默认值）
- ✅ 允许: 添加索引
- ⚠️ 谨慎: 修改字段类型（需要数据迁移）
- ⚠️ 谨慎: 删除字段（需要数据迁移）
- ❌ 禁止: 修改主键
- ❌ 禁止: 删除外键约束（除非确认无依赖）

**强制先读文档**:
- 修改前必须阅读 `internal/models/db_base.go`
- 修改前必须确认数据库迁移策略

**测试要求**:
- 必须测试模型验证
- 必须测试模型关联
- 必须测试数据迁移

#### 6. internal/middleware/ - 中间件

**风险描述**:
- 认证中间件错误可能导致未授权访问
- 日志中间件错误可能导致无法排查问题
- 恢复中间件错误可能导致应用崩溃

**操作约束**:
- ✅ 允许: 添加新中间件
- ✅ 允许: 修改中间件逻辑（经过测试）
- ⚠️ 谨慎: 修改中间件顺序（影响执行流程）
- ❌ 禁止: 删除认证中间件
- ❌ 禁止: 删除恢复中间件

**强制先读文档**:
- 修改前必须阅读 `internal/middleware/` 下的所有文件
- 修改前必须确认中间件执行顺序

**测试要求**:
- 必须测试认证中间件
- 必须测试授权中间件
- 必须测试错误恢复

#### 7. pkg/jwt/ - JWT 认证

**风险描述**:
- JWT 密钥泄露可能导致认证绕过
- JWT 过期时间设置不当可能导致安全风险
- JWT 验证错误可能导致未授权访问

**操作约束**:
- ✅ 允许: 修改 JWT 过期时间（经过安全评估）
- ✅ 允许: 添加 JWT 刷新机制
- ❌ 禁止: 硬编码 JWT 密钥
- ❌ 禁止: 使用弱加密算法
- ❌ 禁止: 跳过 JWT 验证

**强制先读文档**:
- 修改前必须阅读 `pkg/jwt/README.md`
- 修改前必须阅读 JWT 最佳实践

**测试要求**:
- 必须测试 JWT 生成
- 必须测试 JWT 验证
- 必须测试 JWT 过期
- 必须测试 JWT 刷新

#### 8. pkg/rbac/ - 权限控制

**风险描述**:
- 权限配置错误可能导致越权访问
- 权限策略错误可能导致功能不可用
- 权限缓存错误可能导致权限不一致

**操作约束**:
- ✅ 允许: 添加新角色和权限
- ✅ 允许: 修改权限策略（经过测试）
- ⚠️ 谨慎: 修改权限模型（影响所有权限）
- ❌ 禁止: 删除现有角色（除非确认无使用）
- ❌ 禁止: 跳过权限检查

**强制先读文档**:
- 修改前必须阅读 `pkg/rbac/README.md`
- 修改前必须阅读 Casbin 文档
- 修改前必须确认权限模型

**测试要求**:
- 必须测试权限检查
- 必须测试角色分配
- 必须测试权限缓存

#### 9. pkg/crypto/ - 密码加密

**风险描述**:
- 加密算法选择不当可能导致密码泄露
- 加密参数配置不当可能导致性能问题
- 密码验证错误可能导致认证绕过

**操作约束**:
- ✅ 允许: 使用 bcrypt 加密密码
- ✅ 允许: 调整 bcrypt cost（经过性能测试）
- ❌ 禁止: 使用弱加密算法（如 MD5, SHA1）
- ❌ 禁止: 明文存储密码
- ❌ 禁止: 跳过密码验证

**强制先读文档**:
- 修改前必须阅读 `pkg/crypto/README.md`
- 修改前必须阅读密码加密最佳实践

**测试要求**:
- 必须测试密码加密
- 必须测试密码验证
- 必须测试加密性能

### 🟡 中风险区域

#### 10. internal/repository/ - 数据访问层

**风险描述**:
- 数据访问错误可能导致数据查询异常
- 缓存策略不当可能导致数据不一致
- 分页逻辑错误可能导致数据丢失

**操作约束**:
- ✅ 允许: 实现 Repository 接口
- ✅ 允许: 添加缓存策略
- ⚠️ 谨慎: 修改查询逻辑（确保测试覆盖）
- ❌ 禁止: 绕过 Repository 接口直接访问数据库

**测试要求**:
- 必须测试 CRUD 操作
- 必须测试分页查询
- 必须测试缓存行为

#### 11. internal/service/ - 业务逻辑层

**风险描述**:
- 业务逻辑错误可能导致业务流程异常
- 事务边界不清可能导致数据不一致
- 并发控制不当可能导致竞态条件

**操作约束**:
- ✅ 允许: 实现业务逻辑
- ✅ 允许: 使用事务包装业务操作
- ⚠️ 谨慎: 修改业务规则（确保测试覆盖）
- ❌ 禁止: 在 Service 层直接操作数据库

**测试要求**:
- 必须测试业务逻辑
- 必须测试事务边界
- 必须测试并发场景

#### 12. pkg/logger/ - 日志系统

**风险描述**:
- 日志配置错误可能导致无法排查问题
- 日志级别设置不当可能导致性能问题
- 日志格式错误可能导致日志解析失败

**操作约束**:
- ✅ 允许: 修改日志级别
- ✅ 允许: 修改日志格式
- ⚠️ 谨慎: 修改日志输出目标（确保日志不丢失）
- ❌ 禁止: 在日志中输出敏感信息

**测试要求**:
- 必须测试日志输出
- 必须测试日志轮转
- 必须测试日志格式

### 🟢 低风险区域

#### 13. pkg/cache/ - 缓存系统

**风险描述**:
- 缓存配置不当可能影响性能
- 缓存失效策略不当可能导致数据不一致

**操作约束**:
- ✅ 允许: 修改缓存配置
- ✅ 允许: 添加缓存策略
- ⚠️ 谨慎: 修改缓存键格式（可能导致缓存失效）

**测试要求**:
- 建议测试缓存读写
- 建议测试缓存过期

#### 14. pkg/executor/ - 协程池

**风险描述**:
- 协程池配置不当可能影响性能
- 协程泄露可能导致资源耗尽

**操作约束**:
- ✅ 允许: 修改协程池配置
- ✅ 允许: 添加新的协程池
- ⚠️ 谨慎: 修改协程池大小（需要性能测试）

**测试要求**:
- 建议测试协程池提交
- 建议测试协程池关闭

## 风险操作检查清单

### 修改前检查

- [ ] 确认修改的模块和风险等级
- [ ] 阅读相关文档和注释
- [ ] 确认依赖关系和影响范围
- [ ] 确认是否需要数据库迁移
- [ ] 确认是否需要配置变更

### 修改中检查

- [ ] 遵守操作约束
- [ ] 保持代码风格一致
- [ ] 添加必要的注释
- [ ] 处理所有错误情况
- [ ] 避免引入安全漏洞

### 修改后检查

- [ ] 编写单元测试
- [ ] 编写集成测试
- [ ] 运行所有测试
- [ ] 检查代码覆盖率
- [ ] 更新相关文档
- [ ] 更新技能书（如果需要）

---

**最后更新**: 2026-01-19
